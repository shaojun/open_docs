# 边缘rv1126平台
## 远程连接
### 现状
目前边缘采用长连接`frp client`到`frp server`, 每台边缘使用了`3个(?)`端口, 随着量上升, 很快端口不够用, 同时`frp server`也出现TCP连接数**爆炸**.

### 方案
采用`按需动态创建frp连接`的办法:
1. 在`web`上点击某台电梯的`开启远程连接`
2. 从web后端发送kafka message消息(随机的 ssh port number, camera administration port number, litefcccore web console port number and etc.)至目标边缘.
3. 边缘收取web后端发来的消息后, 启动`frp client`并打开指定端口.
4. 管理人员可以远程管理边缘了.
5. web后端上点击关闭,或者30分钟后自动关闭.
### 工作量
* 边缘    
    动态获取参数+启动frp client - **2天**
* web后端:
    - 一阶段
      仍然使用putty - **1天**
    - 二阶段
      使用web ssh - **1天**
## kafka消息体
### 现状
有两个程序在使用`kafka`消息,分别是`elenet`即`图像识别程序`, 以及 `litefcccore` 即`传感器控制程序`, 两者上传消息流量很大.
### 方案
* 移除不必要的消息
* 降低消息频次
* 减少消息长度
### 工作量
**2天**

## 与kafka服务器的连接
### 现状
使用 `msg.glfiot.com 9092`作为默认kafka server发送消息,如果边缘数量上升, 单一的kafka server将无法负担.
### 方案
边缘采用动态配置下载,以应用从云端配置的参数,并定时获取和应用, 其中就包含kafka server url, 这样可以实现不同边缘连接不同的kafka server,以实现多kafka server的负载均衡.
### 工作量
动态的参数配置下载和应用 - **2天**

 
# DeviceHub
## 多服务器部署
### 现状
采用多进程负载均衡,即每个进程负责一批边缘的消息,如果边缘数量上升,单一机器无法负担.
截至2024年1月初, DeviceHub 每进程(每CPU CORE)目前承担了 140台边缘.
### 方案
允许多台机器部署 DeviceHub 进程

### 工作量
每5000台边缘,需要25个进程(25 CPU CORE),采用多CPU核心的服务2台 - **2天**

## Web后端通讯  
### 现状
目前采用线程池方案, cache了报警以及其它消息, 但如果Web后端出现持续的吞吐量下降,则仍然引起队列爆满.
### 方案
采用持久化队列以存储请求.
### 工作量
**2天**

# kafka broker
## 多服务器的负载均衡
### 现状
单服务器上部署了3 cluster集群, with promethues + grafana + node exporter 监控.
### 方案
允许多台机器部署

### 计划
* 在边缘数量<=5000台时
  需要3台Kafka服务器  **2天**
* 在边缘数量5000至10000台时
  需要6台Kafka服务器  **3天**
  或者上阿里云的kafka平台 **2天**
* 在边缘数量>10000台
  转架构到mqtt协议以减少服务器成本, 可支持每万台1台mqtt server即可,需要边缘改动, 共需要 **5天**

  
# 二次图像识别判定服务器端
## 多服务器的负载均衡
### 现状
单服务器GPU.
### 方案
允许多台机器部署

### 计划
* 在边缘数量<=5000台时
  
* 在边缘数量=10000台时 
需要2台GPU服务器  **2天**
  
* 每5000台,增加一台GPU服务器.
  
# WEB端
## 边缘更新程序后端
### 现状
所有边缘都在同一台服务器进行下载
### 方案
CDN
### 计划
工作量 **2天**

## 报警视频
### 现状
所有报警都在同一台服务器去向萤石云进行下载
### 方案
CDN
### 计划
工作量 **1天**

## 整体接口优化
### 现状
与边缘,大屏的接口性能不佳.
### 方案
进行代码优化
### 计划
工作量 **3天**


## 数据库操作相关优化
### 现状
单数据库
### 方案
分库,分表
### 计划
5000 - **2天**
>5000 **3天**

## Web程序负载均衡
### 现状
单服务单进程
### 方案
多服务器负载均衡.
### 计划
5000    2台服务器 - **2天**
>5000   优化+多台服务器 **3天**


# 全局日志服务
## 边缘
## DeviceHub
## ???
### 方案
应用程序适配 **3天**
使用阿里云  **2天**
使用自建  **4天**

# 安卓大屏
## 广告服务连接
### 现状
边到同一台服务器上
### 方案
分片区连接不同资源服务器

## 多硬件平台方案的支持
### 现状
仅支持单一硬件品牌,包括版本管理等.
### 方案
xxxxx

# 服务器集群管理
## 服务器性能监测
## 服务器报警
netdata **2天**
