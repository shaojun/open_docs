# 现有萤石云功能:    
1. 实时视频流查看    
2. 历史时间点视频回看
3. 历史视频转存    
   用于报警片段的获取.
   如我方需要对指定历史片段进行下载本地存储, 需要先通过萤石云API将指定时间点的历史视频片段从摄像头上传至萤石云中转存储,再我方可以通过萤石云API去下载或者, 所以有平台存储费用.
5. 语音播报
6. 语音对讲    
7. 摄像头及存储卡状态获取以及主动告警
   
# 需求
* 云端存储报警历史时间段的视频
  要低成本, 即现有的萤石云转存储方案成本太高.
  要高成功率,即现有的萤石云转存储方案下载成功率不高.
* 对各品牌摄像头的视频采集具有通用性



# 方案一 : 保留萤石云主要功能,仅实现报警视频片段上传    
主要功能是指去除历史视频转存功能外的萤石云功能.

## 边缘    
从云端来的报警视频获取请求是不可预计和滞后的, 为了总是能够响应云端的任意时间视频段的请求, 同时也为了简化逻辑,边缘则设计为无条件的的持久化摄像头实时视频到本地文件存储, 当收到云端的请求后, 再选择性上传对应时间段的视频片段.
> 持久化的时间肯定是长一些较好,这样给云端留下了操作的空间, 而此时间是基本由边缘本地的存储空间决定的.
> 按720P的视频流, 2Mb码率计算, 每1小时约需要 1GB的空间.
> 按1126板子,半载存储是16GB,而最终实际可用约为4GB, 所以最多存储4小时.

### 任务    
* 评估边缘性能     - 0.5天    
  需要确保在不断记录视频的情况下不影响其它功能.
* 缓存rtsp视频流到本地      - 2天    
  以每1分钟为单位进行文件存储.
* 清理本地视频文件    - 0.5天    
  一定时间后,将自动删除最老的视频文件.
* 收取后端请求    - 3天    
  需要与云端共同定义请求消息的发送方式和格式内容.
* 上传到云端    - 4天    
  上传失败要有重试, 失败要有通知
* 维护    - 2天    

**合计: 12人天**

## 视频服务后端    
当收到报警结束通知后, 向边缘端发起拉取指定时间段视频的请求,并开放待上传接口.

### 任务    
* 评估带宽和存储要求    - 0.5天    
  按平均一个报警2分钟,则视频文件尺寸为34MB.
* 向边缘发送消息    - 2天    
  有收到报警结束通知后, 需要向边缘发起视频片段上传请求, 需要与边缘端共同定义请求消息的发送方式和格式内容.
* 开放上传路径    - 2天    
  需要开放一个唯一的路径,以供边缘上传视频.
* 拼接视频    - 2天    
  边缘上传的是小文件,需要按报警时间进行拼接
* 错误处理    - 1.5天    
  可能会出现边缘视频文件不存在;边缘上传的视频文件部分缺失;
* 维护    - 2天    

**合计: 10人天**

# 方案二 : 全自建,实现全功能,以及报警视频片段保存上传

  
## 任务
* 调研支持GB28181的流媒体服务器软件
* 搭建和部署流媒体服务器
  考虑未来边缘摄像头的增长的扩容需求
* 开放实时和历史点回看接口
  供web前端等调用
* 报警历史片段的存储
* 语音播报
* 语音对讲
* 摄像头及存储卡状态获取以及主动告警

