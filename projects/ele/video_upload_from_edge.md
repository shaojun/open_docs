# 需求
客户直接需求: 云端需要收集报警起始到结束时间段的视频片段.

进一步的需求:
* 不需要通过第三方摄像头平台来传送视频
* 对各品牌摄像头的视频采集具有通用性
* 边缘能够按需调用摄像头的私有API    
  因不走第三方摄像头平台后,一些摄像头功能也将无法简单实现,那就需要在本地进行私有API调用,以实现摄像头设置, 语音播放, MIC收集声音并传送给云端等.
  > !!!此功能的实现并不包含在此项目中, 此项目仅需要考虑做一些必要的前瞻基本设计来支持未来的可能需求.


# 报警视频上传方案
## 边缘    
从云端来的报警视频获取请求是不可预计和滞后的, 为了总是能够响应云端的任意时间视频段的请求, 同时也为了简化逻辑,边缘则设计为无条件的的持久化摄像头实时视频到本地文件存储, 当收到云端的请求后, 再选择性上传对应时间段的视频片段.
> 持久化的时间肯定是长一些较好,这样给云端留下了操作的空间, 而此时间是基本由边缘本地的存储空间决定的.
> 按720P的视频流, 2Mb码率计算, 每1小时约需要 1GB的空间.
> 按1126板子,半载存储是16GB,而最终实际可用约为4GB, 所以最多存储4小时.
### 任务    
* 评估边缘性能     - 0.5天    
  需要确保在不断记录视频的情况下不影响其它功能.
* 缓存rtsp视频流到本地      - 2天    
  以每1分钟为单位进行文件存储.
* 清理本地视频文件    - 0.5天    
  一定时间后,将自动删除最老的视频文件.
* 收取后端请求    - 3天    
  需要与云端共同定义请求消息的发送方式和格式内容.
* 上传到云端    - 4天    
  上传失败要有重试, 失败要有通知
* 维护    - 2天    
  
## 视频服务后端    
在收到某个报警结束的通知后,马上向边缘发请视频片段获取请求.
### 任务    
* 评估带宽和存储要求    - 0.5天    
  按平均一个报警2分钟,则视频文件尺寸为34MB.
* 向边缘发送消息    - 2天    
  有收到报警结束通知后, 需要向边缘发起视频片段上传请求, 需要与边缘端共同定义请求消息的发送方式和格式内容.
* 开放上传路径    - 2天    
  需要开放一个唯一的路径,以供边缘上传视频.
* 拼接视频    - 2天    
  边缘上传的是小文件,需要按报警时间进行拼接
* 错误处理    - 1.5天    
  可能会出现边缘视频文件不存在;边缘上传的视频文件部分缺失;
* 维护    - 2天    




# 萤石云功能
1. 实时视频流查看
2. 历史视频回看
3. 历史视频转存    
   用于报警片段的获取.
   目前是视频片段需要在萤石云中转存储,再可以通过API由调用端获取, 所以有平台存储费用.
5. 语音播报
6. 语音对讲    
7. 摄像头及存储卡状态获取以及主动告警    
# 替换方案
## 自建流媒体服务器,摄像头通过GB28181直接接入

## 自建流媒体服务器,摄像头通过边缘代理推流
边缘rtsp连接到摄像头, 边缘作为推流代理.
