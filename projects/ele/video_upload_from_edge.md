# 现有萤石云功能:    
1. 实时视频流查看    
2. 历史时间点视频回看
3. 历史视频转存    
   用于报警片段的获取.
   如我方需要对指定历史片段进行下载本地存储, 需要先通过萤石云API将指定时间点的历史视频片段从摄像头上传至萤石云中转存储,再我方可以通过萤石云API去下载或者, 所以有平台存储费用.
5. 语音播报
6. 语音对讲    
7. 摄像头及存储卡状态获取以及主动告警
   
# 需求
* 云端存储报警历史时间段的视频
  要低成本, 即现有的萤石云转存储方案成本太高.
  要高成功率,即现有的萤石云转存储方案下载成功率不高.
* 对各品牌摄像头的视频采集具有通用性



# 方案一: 保留萤石云主要功能,仅实现报警视频片段上传    
主要功能是指去除历史视频转存功能外的萤石云功能.

## 边缘    
从云端来的报警视频获取请求是不可预计和滞后的, 为了总是能够响应云端的任意时间视频段的请求, 同时也为了简化逻辑,边缘则设计为无条件的的持久化摄像头实时视频到本地文件存储, 当收到云端的请求后, 再选择性上传对应时间段的视频片段.
> 持久化的时间肯定是长一些较好,这样给云端留下了操作的空间, 而此时间是基本由边缘本地的存储空间决定的.
> 按720P的视频流, 2Mb码率计算, 每1小时约需要 1GB的空间.
> 按1126板子,半载存储是16GB,而最终实际可用约为4GB, 所以最多存储4小时.

### 任务    
* 评估边缘性能     - 0.5天    
  需要确保在不断记录视频的情况下不影响其它功能.
* 缓存rtsp视频流到本地      - 2天    
  以每1分钟为单位进行文件存储.
* 清理本地视频文件    - 0.5天    
  一定时间后,将自动删除最老的视频文件.
* 收取后端请求    - 3天    
  需要与云端共同定义请求消息的发送方式和格式内容.
* 上传到云端    - 4天    
  上传失败要有重试, 失败要有通知
* 维护    - 2天    

**合计: 12人天**

## 视频服务后端    
当收到报警结束通知后, 向边缘端发起拉取指定时间段视频的请求,并开放待上传接口.

### 任务    
* 评估带宽和存储要求    - 0.5天    
  按平均一个报警2分钟,则视频文件尺寸为34MB.
* 向边缘发送消息    - 2天    
  有收到报警结束通知后, 需要向边缘发起视频片段上传请求, 需要与边缘端共同定义请求消息的发送方式和格式内容.
* 开放上传路径    - 2天    
  需要开放一个唯一的路径,以供边缘上传视频.
* 拼接视频    - 2天    
  边缘上传的是小文件,需要按报警时间进行拼接
* 错误处理    - 1.5天    
  可能会出现边缘视频文件不存在;边缘上传的视频文件部分缺失;
* 维护    - 2天    

**合计: 10人天**

# 方案二: 对接移动视频服务平台
相当于对萤石云做功能的平移,但根据与平台技术的沟通,有以下问题：
1. 如何获取存储卡状态？（不支持）
2. 如何实现语音播报（不支持）
3. 如何实现语音对讲（不支持）
4. 如何抓取摄像头画面（仅可通过抓取视频流抽帧实现）
5. 抓取摄像头视频（文档有接口定义，但未做实际测试）
6. 视频播放器的兼容性(至3月27日仅提供了PC端的播放器插件,还未实际测试, 其它则不确定是否支持手机等平台)

# 方案三: 全自建,实现全功能,以及报警视频片段保存上传  
## 任务
* 调研支持GB28181的流媒体服务器软件    - 2天
* 搭建和部署流媒体服务器    - 20天
  考虑未来边缘摄像头的增长的扩容需求
* 开放实时和历史点回看接口    -5天
  供web前端等调用
* 报警历史片段的存储    -2天
* 语音播报    -3天
* 语音对讲    -3天
* 摄像头及存储卡状态获取以及主动告警    -2天

**应该要注意的:**
通过市面上的开源项目搭建推流平台， 目前开源项目多数并不成熟，只是部分支持相关的功能，比如支持推流但不一定支持回放。支持回放当不一定支持语音广播等。
即使号称支持的功能也许要实际测试才能确认是否正常工作.

